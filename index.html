<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Applicazione per la gestione del budget familiare con sincronizzazione Google Sheets">
    <title>Budget Familiare</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        .category-card {
            transition: all 0.3s ease;
        }

        .category-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="bg-gray-50">
    <div id="app" class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">üí∞ Gestione Budget Familiare</h1>
                    <p class="text-gray-600">Tieni sotto controllo entrate e uscite della tua famiglia</p>
                </div>
                <div id="storageIndicator" class="text-sm"></div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-green-500 rounded-lg shadow-md p-6 text-white">
                <div class="text-sm opacity-90">Entrate Totali</div>
                <div class="text-3xl font-bold" id="totalIncome">‚Ç¨0.00</div>
            </div>
            <div class="bg-red-500 rounded-lg shadow-md p-6 text-white">
                <div class="text-sm opacity-90">Spese Totali</div>
                <div class="text-3xl font-bold" id="totalExpenses">‚Ç¨0.00</div>
            </div>
            <div class="bg-blue-500 rounded-lg shadow-md p-6 text-white">
                <div class="text-sm opacity-90">Bilancio</div>
                <div class="text-3xl font-bold" id="balance">‚Ç¨0.00</div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Add Transaction Form -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">‚ûï Nuova Transazione</h2>
                    <button type="button" onclick="openReceiptScanner()"
                        class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition flex items-center gap-2">
                        üì∑ Scansiona Scontrino
                    </button>
                </div>
                <form id="transactionForm">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Tipo</label>
                        <div class="flex gap-4">
                            <label class="flex items-center">
                                <input type="radio" name="type" value="income" class="mr-2" checked>
                                <span class="text-green-600">Entrata</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="type" value="expense" class="mr-2">
                                <span class="text-red-600">Spesa</span>
                            </label>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Descrizione</label>
                        <input type="text" id="description"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Importo (‚Ç¨)</label>
                        <input type="number" id="amount" step="0.01"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Categoria</label>
                        <select id="category"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Data</label>
                        <input type="date" id="date"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required>
                    </div>

                    <button type="submit"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition">
                        Aggiungi Transazione
                    </button>
                </form>
            </div>

            <!-- Charts -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">üìä Spese per Categoria</h2>
                <canvas id="expensesChart"></canvas>
            </div>
        </div>

        <!-- Budget Forecast -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">üîÆ Previsione Budget</h2>
                <button onclick="toggleForecastSettings()"
                    class="text-blue-600 hover:text-blue-800 text-sm font-semibold">
                    ‚öôÔ∏è Impostazioni
                </button>
            </div>

            <!-- Forecast Settings -->
            <div id="forecastSettings" class="hidden mb-6 p-4 bg-blue-50 rounded-lg">
                <h3 class="font-semibold text-gray-700 mb-3">Configurazione Previsione</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Mesi da analizzare (storico)</label>
                        <input type="number" id="forecastHistoryMonths" value="3" min="1" max="12"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Mesi da prevedere</label>
                        <input type="number" id="forecastFutureMonths" value="3" min="1" max="6"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <button onclick="updateForecast()"
                    class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition">
                    Aggiorna Previsione
                </button>
            </div>

            <!-- Forecast Chart -->
            <div class="mb-6">
                <canvas id="forecastChart"></canvas>
            </div>

            <!-- Forecast Details -->
            <div id="forecastDetails" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Transactions List -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">üìã Transazioni Recenti</h2>
                <select id="filterMonth"
                    class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="all">Tutti i mesi</option>
                </select>
            </div>
            <div id="transactionsList" class="space-y-2">
                <!-- Transactions will be populated here -->
            </div>
        </div>

        <!-- Category Management -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">üè∑Ô∏è Gestione Categorie</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="categoriesList">
                <!-- Categories will be populated here -->
            </div>
        </div>
    </div>

    <!-- Receipt Scanner Modal -->
    <div id="receiptScannerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
        style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">üì∑ Scansiona Scontrino</h3>
                <button onclick="closeReceiptScanner()"
                    class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>

            <!-- Upload Options -->
            <div id="receiptUploadSection" class="space-y-4">
                <p class="text-gray-600 text-sm">Carica una foto dello scontrino per estrarre automaticamente i dati.
                </p>

                <div class="flex flex-col sm:flex-row gap-3">
                    <label class="flex-1 cursor-pointer">
                        <div
                            class="bg-blue-50 hover:bg-blue-100 border-2 border-dashed border-blue-300 rounded-lg p-6 text-center transition">
                            <div class="text-4xl mb-2">üìÅ</div>
                            <div class="text-blue-600 font-semibold">Carica Immagine</div>
                            <div class="text-gray-500 text-sm">JPG, PNG, HEIC</div>
                        </div>
                        <input type="file" id="receiptFileInput" accept="image/*" class="hidden"
                            onchange="handleReceiptImage(event)">
                    </label>

                    <label class="flex-1 cursor-pointer">
                        <div
                            class="bg-green-50 hover:bg-green-100 border-2 border-dashed border-green-300 rounded-lg p-6 text-center transition">
                            <div class="text-4xl mb-2">üì∏</div>
                            <div class="text-green-600 font-semibold">Scatta Foto</div>
                            <div class="text-gray-500 text-sm">Usa la fotocamera</div>
                        </div>
                        <input type="file" id="receiptCameraInput" accept="image/*" capture="environment" class="hidden"
                            onchange="handleReceiptImage(event)">
                    </label>
                </div>
            </div>

            <!-- Image Preview -->
            <div id="receiptPreviewSection" class="hidden mt-4">
                <img id="receiptPreview" class="w-full rounded-lg border border-gray-200" alt="Anteprima scontrino">
            </div>

            <!-- Processing Progress -->
            <div id="receiptProcessingSection" class="hidden mt-4">
                <div class="bg-blue-50 rounded-lg p-4">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                        <span class="text-blue-800 font-semibold">Elaborazione in corso...</span>
                    </div>
                    <div class="w-full bg-blue-200 rounded-full h-2">
                        <div id="receiptProgressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                            style="width: 0%"></div>
                    </div>
                    <p id="receiptProgressText" class="text-blue-600 text-sm mt-2">Inizializzazione OCR...</p>
                </div>
            </div>

            <!-- Results Section -->
            <div id="receiptResultsSection" class="hidden mt-4">
                <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                    <h4 class="font-bold text-green-800 mb-3">‚úÖ Dati Estratti</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-1">Importo</label>
                            <input type="text" id="extractedAmount"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Non rilevato">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-1">Data</label>
                            <input type="date" id="extractedDate"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-1">Descrizione</label>
                            <input type="text" id="extractedDescription"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Non rilevato">
                        </div>
                    </div>
                </div>

                <div class="flex gap-3 mt-4">
                    <button onclick="applyReceiptData()"
                        class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition">
                        ‚úì Applica al Form
                    </button>
                    <button onclick="resetReceiptScanner()"
                        class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-2 px-4 rounded-lg transition">
                        ‚Ü∫ Nuova Scansione
                    </button>
                </div>
            </div>

            <!-- Error Section -->
            <div id="receiptErrorSection" class="hidden mt-4">
                <div class="bg-red-50 rounded-lg p-4 border border-red-200">
                    <h4 class="font-bold text-red-800 mb-2">‚ùå Errore</h4>
                    <p id="receiptErrorText" class="text-red-600"></p>
                    <button onclick="resetReceiptScanner()"
                        class="mt-3 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition">
                        Riprova
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION - URL WEBHOOK CONFIGURATO ‚úÖ
        // ============================================
        const N8N_WEBHOOK_URL = 'https://n8n.srv1194161.hstgr.cloud/webhook/family-budget';
        const USE_N8N_STORAGE = true; // true = Google Sheets via n8n, false = storage locale

        // Default Categories
        const DEFAULT_INCOME_CATEGORIES = [
            { name: 'Stipendio', icon: 'üíº' },
            { name: 'Freelance', icon: 'üíª' },
            { name: 'Affitto', icon: 'üè†' },
            { name: 'Investimenti', icon: 'üìà' },
            { name: 'Altro', icon: 'üí∞' }
        ];

        const DEFAULT_EXPENSE_CATEGORIES = [
            { name: 'Casa', icon: 'üè†' },
            { name: 'Alimentari', icon: 'üõí' },
            { name: 'Trasporti', icon: 'üöó' },
            { name: 'Utenze', icon: 'üí°' },
            { name: 'Salute', icon: '‚öïÔ∏è' },
            { name: 'Istruzione', icon: 'üìö' },
            { name: 'Intrattenimento', icon: 'üé¨' },
            { name: 'Ristorazione', icon: 'üçΩÔ∏è' },
            { name: 'Abbigliamento', icon: 'üëî' },
            { name: 'Altro', icon: 'üì¶' }
        ];

        // State management
        let transactions = [];
        let incomeCategories = [...DEFAULT_INCOME_CATEGORIES];
        let expenseCategories = [...DEFAULT_EXPENSE_CATEGORIES];
        let chart = null;
        let forecastChart = null;

        // Initialize app
        async function initApp() {
            updateStorageIndicator();
            await loadData();
            setupEventListeners();
            updateCategorySelect();
            renderAll();
            setTodayDate();
            populateMonthFilter();
        }

        // Storage Helper - Robust fallback for different environments
        const db = {
            async get(key) {
                try {
                    if (window.storage && typeof window.storage.get === 'function') {
                        return await window.storage.get(key);
                    }
                    return { value: localStorage.getItem(key) };
                } catch (e) {
                    console.warn('Storage get error:', e);
                    return { value: localStorage.getItem(key) };
                }
            },
            async set(key, value) {
                try {
                    if (window.storage && typeof window.storage.set === 'function') {
                        return await window.storage.set(key, value);
                    }
                    localStorage.setItem(key, value);
                } catch (e) {
                    console.warn('Storage set error:', e);
                    localStorage.setItem(key, value);
                }
            }
        };

        // Update storage indicator
        function updateStorageIndicator() {
            const indicator = document.getElementById('storageIndicator');
            if (USE_N8N_STORAGE) {
                indicator.innerHTML = `
                    <div class="flex items-center gap-2 bg-green-100 text-green-800 px-3 py-1 rounded-full">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                        <span class="font-semibold">Google Sheets</span>
                    </div>
                `;
            } else {
                indicator.innerHTML = `
                    <div class="flex items-center gap-2 bg-blue-100 text-blue-800 px-3 py-1 rounded-full">
                        <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                        <span class="font-semibold">Storage Locale</span>
                    </div>
                `;
            }
        }

        // Load data from storage
        async function loadData() {
            // 1. Load categories first (local)
            try {
                const storedIncome = await db.get('family-budget-income-categories');
                const storedExpense = await db.get('family-budget-expense-categories');
                if (storedIncome && storedIncome.value) incomeCategories = JSON.parse(storedIncome.value);
                if (storedExpense && storedExpense.value) expenseCategories = JSON.parse(storedExpense.value);
            } catch (error) {
                console.warn('Error loading categories, using defaults', error);
            }

            // 2. Load transactions
            if (USE_N8N_STORAGE) {
                try {
                    const response = await fetch(N8N_WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ operation: 'load' })
                    });

                    if (!response.ok) throw new Error('Failed to load from n8n');

                    const data = await response.json();
                    transactions = data.transactions || [];
                } catch (error) {
                    console.error('Error loading from n8n:', error);
                    alert('Errore nel caricamento dei dati da Google Sheets. Verificare la connessione n8n.');
                    transactions = [];
                }
            } else {
                try {
                    const result = await db.get('family-budget-transactions');
                    if (result && result.value) {
                        transactions = JSON.parse(result.value);
                    }
                } catch (error) {
                    console.log('No previous transactions found', error);
                    transactions = [];
                }
            }
        }

        // Save categories to storage
        async function saveCategories() {
            await db.set('family-budget-income-categories', JSON.stringify(incomeCategories));
            await db.set('family-budget-expense-categories', JSON.stringify(expenseCategories));
        }

        // Save data to storage
        async function saveData() {
            if (USE_N8N_STORAGE) {
                return;
            } else {
                try {
                    await db.set('family-budget-transactions', JSON.stringify(transactions));
                } catch (error) {
                    console.error('Error saving data:', error);
                    alert('Errore nel salvare i dati');
                }
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('transactionForm').addEventListener('submit', handleAddTransaction);
            document.querySelectorAll('input[name="type"]').forEach(radio => {
                radio.addEventListener('change', updateCategorySelect);
            });
            document.getElementById('filterMonth').addEventListener('change', renderTransactionsList);
        }

        // Set today's date as default
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        }

        // Update category select based on transaction type
        function updateCategorySelect() {
            const typeValue = document.querySelector('input[name="type"]:checked').value;
            const categories = typeValue === 'income' ? incomeCategories : expenseCategories;
            const select = document.getElementById('category');

            select.innerHTML = categories.map(cat =>
                `<option value="${cat.name}">${cat.icon} ${cat.name}</option>`
            ).join('');
        }

        // Handle add transaction
        async function handleAddTransaction(e) {
            e.preventDefault();

            const transaction = {
                id: Date.now(),
                type: document.querySelector('input[name="type"]:checked').value,
                description: document.getElementById('description').value,
                amount: parseFloat(document.getElementById('amount').value),
                category: document.getElementById('category').value,
                date: document.getElementById('date').value
            };

            if (USE_N8N_STORAGE) {
                // Save to Google Sheets via n8n
                try {
                    const response = await fetch(N8N_WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            operation: 'save',
                            transaction: transaction
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to save to n8n');
                    }

                    // Add to local array for immediate display
                    transactions.unshift(transaction);
                } catch (error) {
                    console.error('Error saving to n8n:', error);
                    alert('Errore nel salvare la transazione su Google Sheets');
                    return;
                }
            } else {
                // Save to local storage
                transactions.unshift(transaction);
                await saveData();
            }

            // Reset form
            document.getElementById('transactionForm').reset();
            setTodayDate();
            updateCategorySelect();

            renderAll();
        }

        // Delete transaction
        async function deleteTransaction(id) {
            if (confirm('Sei sicuro di voler eliminare questa transazione?')) {
                if (USE_N8N_STORAGE) {
                    // For Google Sheets, we need to reload all data to find the row
                    // This is a limitation - in production you'd track row numbers
                    transactions = transactions.filter(t => t.id !== id);
                    alert('Nota: per Google Sheets, ricaricare la pagina per sincronizzare le eliminazioni');
                } else {
                    transactions = transactions.filter(t => t.id !== id);
                    await saveData();
                }
                renderAll();
            }
        }

        // Calculate totals
        function calculateTotals(transactionsToCalc = transactions) {
            const income = transactionsToCalc
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);

            const expenses = transactionsToCalc
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);

            return { income, expenses, balance: income - expenses };
        }

        // Update summary cards
        function updateSummary() {
            const { income, expenses, balance } = calculateTotals();

            document.getElementById('totalIncome').textContent = `‚Ç¨${income.toFixed(2)}`;
            document.getElementById('totalExpenses').textContent = `‚Ç¨${expenses.toFixed(2)}`;
            document.getElementById('balance').textContent = `‚Ç¨${balance.toFixed(2)}`;

            // Update balance color
            const balanceEl = document.getElementById('balance').parentElement;
            balanceEl.className = balanceEl.className.replace(/bg-(green|red|blue)-500/,
                balance > 0 ? 'bg-green-500' : balance < 0 ? 'bg-red-500' : 'bg-blue-500');
        }

        // Populate month filter
        function populateMonthFilter() {
            const months = new Set();
            transactions.forEach(t => {
                const date = new Date(t.date);
                const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                months.add(monthYear);
            });

            const select = document.getElementById('filterMonth');
            const currentOptions = select.innerHTML;

            Array.from(months).sort().reverse().forEach(monthYear => {
                const [year, month] = monthYear.split('-');
                const date = new Date(year, month - 1);
                const monthName = date.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });

                if (!select.querySelector(`option[value="${monthYear}"]`)) {
                    select.innerHTML += `<option value="${monthYear}">${monthName}</option>`;
                }
            });
        }

        // Filter transactions by month
        function getFilteredTransactions() {
            const filterValue = document.getElementById('filterMonth').value;
            if (filterValue === 'all') return transactions;

            return transactions.filter(t => {
                const date = new Date(t.date);
                const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                return monthYear === filterValue;
            });
        }

        // Render transactions list
        function renderTransactionsList() {
            const filteredTransactions = getFilteredTransactions();
            const container = document.getElementById('transactionsList');

            if (filteredTransactions.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Nessuna transazione trovata</p>';
                return;
            }

            container.innerHTML = filteredTransactions.map(t => {
                const categories = t.type === 'income' ? incomeCategories : expenseCategories;
                const category = categories.find(c => c.name === t.category);
                const icon = category ? category.icon : 'üì¶';

                return `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                        <div class="flex items-center gap-4 flex-1">
                            <span class="text-2xl">${icon}</span>
                            <div class="flex-1">
                                <div class="font-semibold text-gray-800">${t.description}</div>
                                <div class="text-sm text-gray-500">${t.category} ‚Ä¢ ${new Date(t.date).toLocaleDateString('it-IT')}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="font-bold ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                                ${t.type === 'income' ? '+' : '-'}‚Ç¨${t.amount.toFixed(2)}
                            </span>
                            <button onclick="deleteTransaction(${t.id})" class="text-red-500 hover:text-red-700">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render expenses chart
        function renderChart() {
            const filteredTransactions = getFilteredTransactions();
            const expensesByCategory = {};

            filteredTransactions
                .filter(t => t.type === 'expense')
                .forEach(t => {
                    expensesByCategory[t.category] = (expensesByCategory[t.category] || 0) + t.amount;
                });

            const categories = Object.keys(expensesByCategory);
            const amounts = Object.values(expensesByCategory);

            if (chart) {
                chart.destroy();
            }

            const ctx = document.getElementById('expensesChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        data: amounts,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
                            '#4BC0C0', '#FF9F40'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `${context.label}: ‚Ç¨${context.parsed.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Render categories list
        function renderCategories() {
            const container = document.getElementById('categoriesList');
            const expensesByCategory = {};

            transactions
                .filter(t => t.type === 'expense')
                .forEach(t => {
                    expensesByCategory[t.category] = (expensesByCategory[t.category] || 0) + t.amount;
                });

            let html = expenseCategories.map(cat => {
                const amount = expensesByCategory[cat.name] || 0;
                return `
                    <div class="category-card p-4 bg-gray-50 rounded-lg text-center relative group">
                        <div class="text-3xl mb-2">${cat.icon}</div>
                        <div class="font-semibold text-gray-800 text-sm">${cat.name}</div>
                        <div class="text-blue-600 font-bold">‚Ç¨${amount.toFixed(2)}</div>
                        <button onclick="deleteCategory('expense', '${cat.name}')" class="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition text-xs bg-red-100 text-red-600 p-1 rounded hover:bg-red-200">
                            üóëÔ∏è
                        </button>
                    </div>
                `;
            }).join('');

            // Add Category Form
            html += `
                <div class="p-4 border-2 border-dashed border-gray-200 rounded-lg flex flex-col items-center justify-center gap-2">
                    <input type="text" id="newCatIcon" placeholder="üé®" class="w-10 text-center border rounded">
                    <input type="text" id="newCatName" placeholder="Nome" class="w-full text-xs border rounded p-1">
                    <button onclick="addCategory('expense')" class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 w-full font-bold">
                        ‚ûï Aggiungi
                    </button>
                </div>
            `;

            container.innerHTML = html;
        }

        // Logic to add a category
        async function addCategory(type) {
            const nameInput = document.getElementById('newCatName');
            const iconInput = document.getElementById('newCatIcon');
            const name = nameInput.value.trim();
            const icon = iconInput.value.trim() || 'üì¶';

            if (!name) return alert('Inserisci un nome per la categoria');

            const categories = type === 'expense' ? expenseCategories : incomeCategories;
            if (categories.some(c => c.name.toLowerCase() === name.toLowerCase())) {
                return alert('Questa categoria esiste gi√†');
            }

            categories.push({ name, icon });
            await saveCategories();
            nameInput.value = '';
            iconInput.value = '';

            renderAll();
            updateCategorySelect();
        }

        // Logic to delete a category
        async function deleteCategory(type, name) {
            if (name === 'Altro') return alert('Non puoi eliminare la categoria "Altro"');

            if (confirm(`Sei sicuro di voler eliminare la categoria "${name}"? Le transazioni associate verranno spostate in "Altro".`)) {
                // Reassign transactions
                transactions.forEach(t => {
                    if (t.category === name) t.category = 'Altro';
                });

                if (type === 'expense') {
                    expenseCategories = expenseCategories.filter(c => c.name !== name);
                } else {
                    incomeCategories = incomeCategories.filter(c => c.name !== name);
                }

                await saveCategories();
                if (!USE_N8N_STORAGE) await saveData(); // Save transaction reassignments locally

                renderAll();
                updateCategorySelect();
            }
        }

        window.addCategory = addCategory;
        window.deleteCategory = deleteCategory;

        // Toggle forecast settings
        function toggleForecastSettings() {
            const settings = document.getElementById('forecastSettings');
            settings.classList.toggle('hidden');
        }

        // Expose functions to window for onclick handlers
        window.toggleForecastSettings = toggleForecastSettings;

        // Get monthly data
        function getMonthlyData() {
            const monthlyData = {};

            transactions.forEach(t => {
                const date = new Date(t.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { income: 0, expenses: 0 };
                }

                if (t.type === 'income') {
                    monthlyData[monthKey].income += t.amount;
                } else {
                    monthlyData[monthKey].expenses += t.amount;
                }
            });

            return monthlyData;
        }

        // Calculate average from historical data
        function calculateAverages(monthlyData, historyMonths) {
            const sortedMonths = Object.keys(monthlyData).sort().reverse();
            const recentMonths = sortedMonths.slice(0, historyMonths);

            let totalIncome = 0;
            let totalExpenses = 0;
            let count = 0;

            recentMonths.forEach(month => {
                totalIncome += monthlyData[month].income;
                totalExpenses += monthlyData[month].expenses;
                count++;
            });

            return {
                avgIncome: count > 0 ? totalIncome / count : 0,
                avgExpenses: count > 0 ? totalExpenses / count : 0,
                monthsCounted: count
            };
        }

        // Generate forecast data
        function generateForecast() {
            const historyMonths = parseInt(document.getElementById('forecastHistoryMonths').value) || 3;
            const futureMonths = parseInt(document.getElementById('forecastFutureMonths').value) || 3;

            const monthlyData = getMonthlyData();
            const { avgIncome, avgExpenses, monthsCounted } = calculateAverages(monthlyData, historyMonths);

            // Get last 6 months of actual data
            const sortedMonths = Object.keys(monthlyData).sort();
            const last6Months = sortedMonths.slice(-6);

            // Generate future months
            const today = new Date();
            const futureMonthsData = [];

            for (let i = 1; i <= futureMonths; i++) {
                const futureDate = new Date(today.getFullYear(), today.getMonth() + i, 1);
                const monthKey = `${futureDate.getFullYear()}-${String(futureDate.getMonth() + 1).padStart(2, '0')}`;
                futureMonthsData.push(monthKey);
            }

            return {
                historicalMonths: last6Months,
                monthlyData,
                futureMonths: futureMonthsData,
                avgIncome,
                avgExpenses,
                avgBalance: avgIncome - avgExpenses,
                monthsCounted
            };
        }

        // Format month for display
        function formatMonth(monthKey) {
            const [year, month] = monthKey.split('-');
            const date = new Date(year, month - 1);
            return date.toLocaleDateString('it-IT', { month: 'short', year: 'numeric' });
        }

        // Update forecast visualization
        function updateForecast() {
            const forecast = generateForecast();

            // Prepare chart data
            const labels = [...forecast.historicalMonths.map(formatMonth), ...forecast.futureMonths.map(formatMonth)];
            const incomeData = [];
            const expensesData = [];
            const balanceData = [];

            // Historical data
            forecast.historicalMonths.forEach(month => {
                const data = forecast.monthlyData[month] || { income: 0, expenses: 0 };
                incomeData.push(data.income);
                expensesData.push(data.expenses);
                balanceData.push(data.income - data.expenses);
            });

            // Forecast data
            forecast.futureMonths.forEach(() => {
                incomeData.push(forecast.avgIncome);
                expensesData.push(forecast.avgExpenses);
                balanceData.push(forecast.avgBalance);
            });

            // Render chart
            if (forecastChart) {
                forecastChart.destroy();
            }

            const ctx = document.getElementById('forecastChart').getContext('2d');
            forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Entrate',
                            data: incomeData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Spese',
                            data: expensesData,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Bilancio',
                            data: balanceData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderDash: balanceData.map((_, i) =>
                                i >= forecast.historicalMonths.length ? [5, 5] : []
                            )
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const isPrediction = context.dataIndex >= forecast.historicalMonths.length;
                                    const prefix = isPrediction ? '(Prev.) ' : '';
                                    return prefix + context.dataset.label + ': ‚Ç¨' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return '‚Ç¨' + value.toFixed(0);
                                }
                            }
                        }
                    }
                }
            });

            // Render forecast details
            renderForecastDetails(forecast);
        }

        // Render forecast details cards
        function renderForecastDetails(forecast) {
            const container = document.getElementById('forecastDetails');

            const savings = forecast.avgBalance * forecast.futureMonths.length;
            const savingsClass = savings > 0 ? 'text-green-600' : 'text-red-600';

            container.innerHTML = `
                <div class="p-4 bg-gradient-to-br from-green-50 to-green-100 rounded-lg border border-green-200">
                    <div class="text-sm text-gray-600 mb-1">üìà Entrate Medie Mensili</div>
                    <div class="text-2xl font-bold text-green-700">‚Ç¨${forecast.avgIncome.toFixed(2)}</div>
                    <div class="text-xs text-gray-500 mt-1">Basato su ${forecast.monthsCounted} mesi</div>
                </div>
                
                <div class="p-4 bg-gradient-to-br from-red-50 to-red-100 rounded-lg border border-red-200">
                    <div class="text-sm text-gray-600 mb-1">üìâ Spese Medie Mensili</div>
                    <div class="text-2xl font-bold text-red-700">‚Ç¨${forecast.avgExpenses.toFixed(2)}</div>
                    <div class="text-xs text-gray-500 mt-1">Basato su ${forecast.monthsCounted} mesi</div>
                </div>
                
                <div class="p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg border border-blue-200">
                    <div class="text-sm text-gray-600 mb-1">üí∞ Risparmio Previsto</div>
                    <div class="text-2xl font-bold ${savingsClass}">‚Ç¨${savings.toFixed(2)}</div>
                    <div class="text-xs text-gray-500 mt-1">Prossimi ${forecast.futureMonths.length} mesi</div>
                </div>
            `;
        }

        // Render all components
        function renderAll() {
            updateSummary();
            renderTransactionsList();
            renderChart();
            renderCategories();
            populateMonthFilter();
            updateForecast();
        }

        // Expose functions to window for onclick handlers
        window.updateForecast = updateForecast;
        window.deleteTransaction = deleteTransaction;

        // ============================================
        // RECEIPT SCANNER (OCR)
        // ============================================

        // Open receipt scanner modal
        function openReceiptScanner() {
            const modal = document.getElementById('receiptScannerModal');
            modal.style.display = 'flex';
            modal.classList.remove('hidden');
            // Set transaction type to expense by default for receipts
            document.querySelector('input[name="type"][value="expense"]').checked = true;
            updateCategorySelect();
        }

        // Close receipt scanner modal
        function closeReceiptScanner() {
            const modal = document.getElementById('receiptScannerModal');
            modal.style.display = 'none';
            modal.classList.add('hidden');
            resetReceiptScanner();
        }

        // Reset receipt scanner to initial state
        function resetReceiptScanner() {
            document.getElementById('receiptUploadSection').classList.remove('hidden');
            document.getElementById('receiptPreviewSection').classList.add('hidden');
            document.getElementById('receiptProcessingSection').classList.add('hidden');
            document.getElementById('receiptResultsSection').classList.add('hidden');
            document.getElementById('receiptErrorSection').classList.add('hidden');
            document.getElementById('receiptFileInput').value = '';
            document.getElementById('receiptCameraInput').value = '';
            document.getElementById('receiptProgressBar').style.width = '0%';
        }

        // Handle receipt image upload
        async function handleReceiptImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Show preview
            const reader = new FileReader();
            reader.onload = async function (e) {
                document.getElementById('receiptPreview').src = e.target.result;
                document.getElementById('receiptPreviewSection').classList.remove('hidden');
                document.getElementById('receiptUploadSection').classList.add('hidden');

                // Start OCR processing
                await processReceiptOCR(e.target.result);
            };
            reader.readAsDataURL(file);
        }

        // Process receipt with OCR
        async function processReceiptOCR(imageData) {
            document.getElementById('receiptProcessingSection').classList.remove('hidden');

            try {
                const worker = await Tesseract.createWorker('ita', 1, {
                    logger: progress => {
                        if (progress.status === 'recognizing text') {
                            const percent = Math.round(progress.progress * 100);
                            document.getElementById('receiptProgressBar').style.width = percent + '%';
                            document.getElementById('receiptProgressText').textContent = `Riconoscimento testo: ${percent}%`;
                        } else {
                            document.getElementById('receiptProgressText').textContent = progress.status;
                        }
                    }
                });

                const result = await worker.recognize(imageData);
                await worker.terminate();

                // Parse the extracted text
                const extractedData = parseReceiptText(result.data.text);

                // Show results
                document.getElementById('receiptProcessingSection').classList.add('hidden');
                document.getElementById('receiptResultsSection').classList.remove('hidden');

                // Populate extracted data fields
                if (extractedData.amount) {
                    document.getElementById('extractedAmount').value = extractedData.amount;
                }
                if (extractedData.date) {
                    document.getElementById('extractedDate').value = extractedData.date;
                }
                if (extractedData.description) {
                    document.getElementById('extractedDescription').value = extractedData.description;
                }

            } catch (error) {
                console.error('OCR Error:', error);
                document.getElementById('receiptProcessingSection').classList.add('hidden');
                document.getElementById('receiptErrorSection').classList.remove('hidden');
                document.getElementById('receiptErrorText').textContent = 'Impossibile elaborare l\'immagine. Assicurati che sia leggibile e riprova.';
            }
        }

        // Parse receipt text to extract amount, date, and description
        function parseReceiptText(text) {
            const result = { amount: null, date: null, description: null };
            const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);

            console.log('OCR Text:', text); // Debug

            // Extract AMOUNT - look for total patterns
            const amountPatterns = [
                /(?:TOTALE|TOTAL|TOT\.?|IMPORTO|EURO|EUR|‚Ç¨)\s*[:.]?\s*([0-9]+[.,][0-9]{2})/i,
                /([0-9]+[.,][0-9]{2})\s*(?:‚Ç¨|EUR|EURO)/i,
                /‚Ç¨\s*([0-9]+[.,][0-9]{2})/,
                /\*{2,}\s*([0-9]+[.,][0-9]{2})/,  // **12.50 pattern often used for totals
                /([0-9]+[.,][0-9]{2})\s*$/m  // Amount at end of line
            ];

            // First try to find TOTALE specifically
            for (const line of lines) {
                if (/TOTALE|TOTAL|TOT\./i.test(line)) {
                    const match = line.match(/([0-9]+[.,][0-9]{2})/);
                    if (match) {
                        result.amount = match[1].replace(',', '.');
                        break;
                    }
                }
            }

            // If not found, try other patterns
            if (!result.amount) {
                for (const pattern of amountPatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        result.amount = match[1].replace(',', '.');
                        break;
                    }
                }
            }

            // Extract DATE
            const datePatterns = [
                /([0-3]?[0-9])[\/-]([0-1]?[0-9])[\/-](20[0-9]{2}|[0-9]{2})/,  // DD/MM/YYYY or DD-MM-YYYY
                /(20[0-9]{2})[\/-]([0-1]?[0-9])[\/-]([0-3]?[0-9])/,  // YYYY-MM-DD
                /([0-3]?[0-9])\s+(gen|feb|mar|apr|mag|giu|lug|ago|set|ott|nov|dic)[a-z]*\.?\s*(20[0-9]{2}|[0-9]{2})/i
            ];

            for (const pattern of datePatterns) {
                const match = text.match(pattern);
                if (match) {
                    let day, month, year;

                    if (pattern.source.includes('gen|feb')) {
                        // Month name pattern
                        day = match[1].padStart(2, '0');
                        const monthNames = ['gen', 'feb', 'mar', 'apr', 'mag', 'giu', 'lug', 'ago', 'set', 'ott', 'nov', 'dic'];
                        month = String(monthNames.findIndex(m => match[2].toLowerCase().startsWith(m)) + 1).padStart(2, '0');
                        year = match[3].length === 2 ? '20' + match[3] : match[3];
                    } else if (match[1].length === 4) {
                        // YYYY-MM-DD format
                        year = match[1];
                        month = match[2].padStart(2, '0');
                        day = match[3].padStart(2, '0');
                    } else {
                        // DD/MM/YYYY format
                        day = match[1].padStart(2, '0');
                        month = match[2].padStart(2, '0');
                        year = match[3].length === 2 ? '20' + match[3] : match[3];
                    }

                    result.date = `${year}-${month}-${day}`;
                    break;
                }
            }

            // Extract DESCRIPTION - use first meaningful line (store name)
            const skipWords = ['scontrino', 'fiscale', 'n.', 'nr', 'documento', 'ricevuta', 'cassa'];
            for (const line of lines.slice(0, 5)) {
                const lowerLine = line.toLowerCase();
                const isSkip = skipWords.some(word => lowerLine.includes(word));
                if (!isSkip && line.length >= 3 && !/^[0-9\s\-\/.:]+$/.test(line)) {
                    result.description = line.substring(0, 50);
                    break;
                }
            }

            if (!result.description) {
                result.description = 'Acquisto da scontrino';
            }

            return result;
        }

        // Apply extracted data to the transaction form
        function applyReceiptData() {
            const amount = document.getElementById('extractedAmount').value;
            const date = document.getElementById('extractedDate').value;
            const description = document.getElementById('extractedDescription').value;

            if (amount) {
                document.getElementById('amount').value = parseFloat(amount.replace(',', '.'));
            }
            if (date) {
                document.getElementById('date').value = date;
            }
            if (description) {
                document.getElementById('description').value = description;
            }

            closeReceiptScanner();
        }

        // Expose receipt scanner functions to window
        window.openReceiptScanner = openReceiptScanner;
        window.closeReceiptScanner = closeReceiptScanner;
        window.resetReceiptScanner = resetReceiptScanner;
        window.handleReceiptImage = handleReceiptImage;
        window.applyReceiptData = applyReceiptData;

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>

</html>